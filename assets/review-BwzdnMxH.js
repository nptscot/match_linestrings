import{U as Fe,V as Ue,W as We,X as Ke,i as de,Y as o,Z as qe,$ as Qe,a0 as Ye,a1 as Ze,o as je,j as e,x as E,s as j,a2 as ce,v as s,a3 as Ve,u as Z,a4 as he,n as q,E as V,z as y,h as fe,a5 as Xe,k as J,C as H,D as ze,a6 as $e,a7 as De,a8 as Ae,a9 as et,aa as tt,ab as nt,q as b,P as te,ac as ge,J as Ce,Q as ie,ad as rt,R as be,d as Oe,ae as Be,af as He,N as _e,e as Le,I as at,O as ot,g as pe,t as it,L as st,_ as lt,M as ut,S as ct,r as dt,B as ft,G as Me,w as Te,y as vt,A as gt,F as Ee,K as mt,H as ht,T as _t}from"./Settings-Dy5De1sV.js";const pt=Symbol("is custom element"),bt=Symbol("is html");function Ne(f,t,a,g){var m=yt(f);m[t]!==(m[t]=a)&&(t==="loading"&&(f[Fe]=a),a==null?f.removeAttribute(t):typeof a!="string"&&kt(f).includes(t)?f[t]=a:f.setAttribute(t,a))}function yt(f){return f.__attributes??={[pt]:f.nodeName.includes("-"),[bt]:f.namespaceURI===Ue}}var Pe=new Map;function kt(f){var t=Pe.get(f.nodeName);if(t)return t;Pe.set(f.nodeName,t=[]);for(var a,g=f,m=Element.prototype;m!==g;){a=Ke(g);for(var n in a)a[n].set&&t.push(n);g=We(g)}return t}var wt=J('<div class="sv-popup"><!></div>');function xt(f,t){de(t,!0);let a=o(t,"closeButton",3,void 0),g=o(t,"closeOnClickOutside",3,!0),m=o(t,"closeOnClickInside",3,!1),n=o(t,"closeOnMove",3,!1),c=o(t,"openOn",3,"click"),w=o(t,"openIfTopMost",3,!0),_=o(t,"focusAfterOpen",3,!0),N=o(t,"anchor",3,void 0),L=o(t,"offset",3,void 0),O=o(t,"popupClass",3,void 0),S=o(t,"maxWidth",3,void 0),x=o(t,"lngLat",15,void 0),R=o(t,"html",3,void 0),i=o(t,"open",15,!1),z=o(t,"onopen",3,void 0),l=o(t,"onclose",3,void 0),M=o(t,"onhover",3,void 0),h=qe();const p=E($e),v=E(()=>e(p).map),F=E(()=>e(p).eventTopMost),D=E(()=>e(p).markerClickManager),P=E(()=>e(p).loaded),T=Qe(),A=Ye(),u=Ze(),X=["click","dblclick","contextmenu"];let d=j(void 0),$=j(!1),U=j(void 0);function G(){if(!e(d))return;let r=e(d).getElement();!r||r===e(U)||(s(U,r,!0),c()==="hover"&&(e(U).style.pointerEvents="none"),e(U).addEventListener("mouseenter",()=>{s($,!0)},{passive:!0}),e(U).addEventListener("mouseleave",()=>{s($,!1)},{passive:!0}),e(U).addEventListener("click",()=>{m()&&i(!1)},{passive:!0}))}je(()=>{if(e(v))return e(v).on("click",ee),e(v).on("contextmenu",ee),e(D).add(ye),typeof u?.value=="string"&&(e(v).on("click",u.value,B),e(v).on("dblclick",u.value,B),e(v).on("contextmenu",u.value,B),e(v).on("mousemove",u.value,ve),e(v).on("mouseleave",u.value,ae),e(v).on("touchstart",u.value,Y),e(v).on("touchend",u.value,re)),()=>{e(P)&&(e(d)?.remove(),e(v).off("click",ee),e(v).off("contextmenu",ee),e(D).remove(ye),u?.value instanceof ce.Marker?u.value.getPopup()===e(d)&&u.value.setPopup(void 0):typeof u?.value=="string"&&(e(v).off("click",u.value,B),e(v).off("dblclick",u.value,B),e(v).off("contextmenu",u.value,B),e(v).off("mousemove",u.value,ve),e(v).off("mouseleave",u.value,ae),e(v).off("touchstart",u.value,Y),e(v).off("touchend",u.value,re)))}});function K(){if(t.canOpen&&!t.canOpen(e(k))){i(!1);return}i(!0)}function W(r){return w()?!("marker"in r)&&!Xe(r)&&e(F)(r)!==T?.value:!1}let k=j(void 0),I=j("normal");function C(r){"layerType"in r&&r.layerType==="deckgl"?(x(r.coordinate),s(k,r.object?[r.object]:void 0,!0)):(x(r.lngLat),s(k,r.features??[],!0))}function B(r){r.type!==c()||W(r)||(C(r),setTimeout(K))}let Q;function Y(r){Q=r.point}function re(r){if(!Q||c()!=="hover")return;let ne=Q.dist(r.point);Q=void 0,ne<3&&(x(r.lngLat),s(k,r.features??[],!0),e(d)?.isOpen()?s(I,"justOpened"):(s(I,"opening"),K()))}function ae(r){c()!=="hover"||Q||e(I)!=="normal"||(i(!1),s(k,void 0))}function ve(r){if(!(c()!=="hover"||Q||e(I)!=="normal")){if(W(r)){i(!1),s(k,void 0);return}s(k,r.features??[],!0),x(r.lngLat),K()}}function ee(r){if(e(I)==="justOpened"){s(I,"normal");return}if(!g())return;let ne=[e(U),u?.value instanceof ce.Marker?u.value?.getElement():void 0];i()&&e(d)?.isOpen()&&!ne.some(xe=>xe?.contains(r.originalEvent.target))&&(r.type==="contextmenu"&&c()==="contextmenu"||r.type!=="contextmenu")&&i(!1)}function ye(r){g()&&i()&&e(d)?.isOpen()&&r.marker!==u?.value&&i(!1)}Ve(()=>{e(P)&&e(d)?.isOpen()&&e(d).remove()});let oe=j(void 0),ke=E(()=>a()??(!g()&&!m()));Z(()=>{if(!e(d)){let r=O()?`${O()} sv-maplibregl-popup`:"sv-maplibregl-popup";s(d,new ce.Popup({closeButton:e(ke),closeOnClick:!1,closeOnMove:n(),focusAfterOpen:_(),maxWidth:S(),className:r,anchor:N(),offset:L()}),!0),s(U,e(d).getElement(),!0),e(d).on("open",()=>{K(),i()&&(G(),z()?.(e(d)))}),e(d).on("close",()=>{i(!1),l()?.(e(d))}),M()&&e(d).on("hover",()=>{M()?.(e(d))})}}),Z(()=>{e(d)&&u?.value instanceof ce.Marker&&(c()==="click"?u.value.setPopup(e(d)):u.value.getPopup()===e(d)&&u.value.setPopup(void 0))}),Z(()=>{X.includes(c())&&A.value?.type===c()&&(B(A.value),A.value=void 0)});let se=E(()=>c()==="hover"&&(A.value?.type==="mousemove"||A.value?.type==="mouseenter"));Z(()=>{c()==="hover"&&A&&(e(se)&&A.value&&C(A.value),e(se)||e($)?K():i(!1))}),Z(()=>{e(oe)?e(d)?.setDOMContent(e(oe)):R()&&e(d)?.setHTML(R())}),Z(()=>{let r=x()??h?.value??void 0;r&&e(d)?.setLngLat(r)}),Z(()=>{if(e(v)&&e(d)){let r=e(d).isOpen();i()&&!r?(e(d).addTo(e(v)),e(I)==="opening"&&s(I,"justOpened")):!i()&&r&&e(d).remove()}});var le=he(),we=q(le);{var Ge=r=>{var ne=wt(),xe=H(ne);{var Je=ue=>{var Se=he(),Re=q(Se);De(Re,()=>t.children??Ae,()=>({features:e(k),data:e(k)?.[0]??void 0,map:e(v),close:()=>i(!1),isOpen:i()})),y(ue,Se)};V(xe,ue=>{(e(k)?.length||u?.value instanceof ce.Marker||!u&&i())&&ue(Je)})}ze(ne,ue=>s(oe,ue),()=>e(oe)),y(r,ne)};V(we,r=>{t.children&&r(Ge)})}y(f,le),fe()}function Ie(f,t){de(t,!0);let a=o(t,"id",19,()=>et("symbol")),g=o(t,"source",3,void 0),m=o(t,"sourceLayer",3,void 0),n=o(t,"beforeId",3,void 0),c=o(t,"beforeLayerType",3,void 0),w=o(t,"paint",3,void 0),_=o(t,"layout",3,void 0),N=o(t,"filter",3,void 0),L=o(t,"applyToClusters",3,void 0),O=o(t,"minzoom",3,void 0),S=o(t,"maxzoom",3,void 0),x=o(t,"hoverCursor",3,void 0),R=o(t,"manageHoverState",3,!1),i=o(t,"hovered",15),z=o(t,"eventsIfTopMost",3,!1),l=o(t,"interactive",3,!0),M=o(t,"children",3,void 0),h=o(t,"onclick",3,void 0),p=o(t,"ondblclick",3,void 0),v=o(t,"oncontextmenu",3,void 0),F=o(t,"onmouseenter",3,void 0),D=o(t,"onmousemove",3,void 0),P=o(t,"onmouseleave",3,void 0);tt(f,{get id(){return a()},type:"symbol",get source(){return g()},get sourceLayer(){return m()},get beforeId(){return n()},get beforeLayerType(){return c()},get paint(){return w()},get layout(){return _()},get filter(){return N()},get applyToClusters(){return L()},get minzoom(){return O()},get maxzoom(){return S()},get hoverCursor(){return x()},get manageHoverState(){return R()},get eventsIfTopMost(){return z()},get interactive(){return l()},get onclick(){return h()},get ondblclick(){return p()},get oncontextmenu(){return v()},get onmouseenter(){return F()},get onmousemove(){return D()},get onmouseleave(){return P()},get hovered(){return i()},set hovered(T){i(T)},children:(T,A)=>{var u=he(),X=q(u);De(X,()=>M()??Ae),y(T,u)},$$slots:{default:!0}}),fe()}var Ct=J('<div style="display: flex; align-items: center; gap: 6px;"><span></span> </div>'),Lt=J("<div></div>");function Ot(f,t){let a=o(t,"swatchClass",3,"rectangle"),g=o(t,"itemsPerRow",3,2),m=E(()=>`${100/g()}%`);var n=Lt();nt(n,21,()=>Object.entries(t.labelColors),rt,(c,w)=>{var _=E(()=>be(e(w),2));let N=()=>e(_)[0],L=()=>e(_)[1];var O=Ct(),S=H(O);let x;var R=b(S);te(i=>{ge(S,1,`color-swatch ${a()??""}`,"svelte-1enycr6"),x=Ce(S,"",x,i),ie(R,` ${N()??""}`)},[()=>({background:L()})]),y(c,O)}),te(()=>Ce(n,`display: grid; grid-template-columns: repeat(auto-fill, calc(${e(m)??""} - 10px)); gap: 10px;`)),y(f,n)}let me="match-linestrings-review";var St=(f,t)=>t.onConfirm("unreviewed"),Mt=(f,t)=>t.onConfirm("not sure"),Tt=(f,t)=>t.onConfirm("confirmed"),Et=J('<div style="display: flex; justify-content: space-between;"><h3> <!></h3> <button class="btn btn-secondary"><kbd>Escape</kbd> - Back</button></div> <h6>Click sources to add or remove</h6> <div style="display: flex; justify-content: space-between;"><button><kbd>1</kbd> - Unreviewed</button> <button><kbd>2</kbd> - Not sure</button> <button><kbd>3</kbd> - Confirm correct</button></div>',1);function Nt(f,t){de(t,!0);let a=E(()=>t.targetGj.features[t.clickedTarget].properties);function g(h){h.target.tagName!="INPUT"&&(h.key=="1"?t.onConfirm("unreviewed"):h.key=="2"?t.onConfirm("not sure"):h.key=="3"?t.onConfirm("confirmed"):h.key=="Escape"&&t.onCancel())}var m=Et();Be("keydown",He,g);var n=q(m),c=H(n),w=H(c),_=b(w);{var N=h=>{var p=_e();te(v=>ie(p,v),[()=>JSON.stringify(e(a).matching_sources)]),y(h,p)},L=h=>{var p=_e("no matches (off-road)");y(h,p)};V(_,h=>{e(a).matching_sources.length>0?h(N):h(L,!1)})}var O=b(c,2);O.__click=function(...h){t.onCancel?.apply(this,h)};var S=b(n,4),x=H(S);let R;x.__click=[St,t];var i=b(x,2);let z;i.__click=[Mt,t];var l=b(i,2);let M;l.__click=[Tt,t],te((h,p,v)=>{ie(w,`Target ${t.clickedTarget??""}: `),R=ge(x,1,"btn btn-danger svelte-1tzb8bs",null,R,h),z=ge(i,1,"btn btn-warning svelte-1tzb8bs",null,z,p),M=ge(l,1,"btn btn-success svelte-1tzb8bs",null,M,v)},[()=>({current:e(a).reviewed=="unreviewed"}),()=>({current:e(a).reviewed=="not sure"}),()=>({current:e(a).reviewed=="confirmed"})]),y(f,m),fe()}Oe(["click"]);async function Pt(f,t,a,g,m,n,c,w){if(!e(t)?.files)return;if(e(t).files.length!=2){window.alert("Select two GeoJSON files");return}try{let N=await e(t).files[0].text(),L=await e(t).files[1].text();a(g(JSON.parse(N))),m(g(JSON.parse(L))),"matching_sources"in m().features[0].properties?s(n,!0):"matching_sources"in a().features[0].properties&&(s(n,!0),(O=>{var S=be(O,2);a(S[0]),m(S[1])})([m(),a()])),c.zoomFit(),w()}catch(N){window.alert(`Bad input file: ${N}`)}}function It(f,t,a,g){(m=>{var n=be(m,2);t(n[0]),a(n[1])})([a(),t()]),g()}var jt=(f,t)=>t(!0),zt=J('<button class="btn btn-secondary">Swap</button> <p> </p> <button class="btn btn-primary mb-5">Start review</button> <!>',1),Dt=J('<label class="form-label">Load two .geojson files <input class="form-control" type="file" multiple/></label> <!>',1);function At(f,t){de(t,!0);let a=o(t,"sourceGj",15),g=o(t,"targetGj",15),m=o(t,"setupDone",15),n=j(!1),c=j(Le({buffer_meters:20,angle_diff_threshold:10,length_ratio_threshold:1.1,midpt_dist_threshold:15}));function w(){if(!e(n))try{let i=JSON.parse(at(JSON.stringify(a()),JSON.stringify(g()),e(c)));for(let[z,l]of g().features.entries())l.properties.matching_sources=i[z].matching_sources,l.properties.reviewed??="unreviewed"}catch(i){window.alert(`Bug: ${i}`)}}let _=j(void 0);function N(i){let z=0;for(let l of i.features)l.id=z++,l.properties??={};return i}var L=Dt(),O=q(L),S=b(H(O));S.__change=[Pt,_,a,N,g,n,t,w],ze(S,i=>s(_,i),()=>e(_));var x=b(O,2);{var R=i=>{var z=zt(),l=q(z);l.__click=[It,a,g,w];var M=b(l,2),h=H(M),p=b(M,2);p.__click=[jt,m];var v=b(p,2);{var F=D=>{ot(D,{onChange:w,get options(){return e(c)},set options(P){s(c,P,!0)}})};V(v,D=>{e(n)||D(F)})}te(D=>{l.disabled=e(n),ie(h,`${a().features.length??""} sources and
    ${g().features.length??""} targets , with ${D??""} matching a source`)},[()=>g().features.filter(D=>D.properties.matching_sources.length>0).length]),y(i,z)};V(x,i=>{a().features.length>0&&i(R)})}y(f,L),fe()}Oe(["change","click"]);function Bt(f,t){ht("reviewed_targets.geojson",JSON.stringify(e(t)))}function Ht(f,t,a,g,m,n){window.confirm("Do you want to discard this review and start over?")&&(s(t,pe(),!0),s(a,pe(),!0),s(g,!1),s(m,null),s(n,!1),window.localStorage.removeItem(me))}var Gt=J('<div style="display: flex; justify-content: space-between;"><button class="btn btn-outline-danger">Start over</button> <button class="btn btn-outline-secondary">Zoom to fit</button></div> <br/> <div class="progress" role="progressbar" aria-valuemin="0"><div class="progress-bar"></div></div> <p> </p> <button class="btn btn-outline-success">Download reviews</button> <div class="mt-5"><!></div> <div class="card"><div class="card-body"><h5 class="card-title">Legend</h5> <!> <p>Thinner lines have a match, thicker are off-road</p></div></div>',1),Jt=J('<h1>Manually specify LineString matchings for test cases</h1> <div><a class="icon-link mb-3" href="https://github.com/nptscot/match_linestrings/blob/main/tests/README.md" target="_blank">About <i class="fa-solid fa-arrow-up-right-from-square"></i></a></div> <!>',1),Rt=J('<button class="btn btn-primary">Goto <kbd>n</kbd> ext unreviewed</button>'),Ft=J('<div class="map-panel svelte-1o1koy1"><!></div>'),Ut=J("<!> <!>",1),Wt=J("<!> <!>",1),Kt=J("<!> <!> <!> <!> <!> <!>",1),qt=J('<div style="position:relative; width: 100%; height: 100vh;"><!></div>');function Qt(f,t){de(t,!0);let a=j(void 0),g=j("Maptiler Dataviz"),m=j(Le(pe())),n=j(Le(pe())),c=j(!1),w=j(!1),_=j(null),N=E(()=>e(_)==null?[]:e(n).features[e(_)].properties.matching_sources),L=E(()=>e(n).features.filter(l=>l.properties.reviewed!="unreviewed").length);je(async()=>{await lt();try{let l=window.localStorage.getItem(me);if(l){let M=JSON.parse(l);(h=>{var p=be(h,2);s(m,p[0],!0),s(n,p[1],!0)})(M),s(c,!0),console.log(`Restored data from local storage ${me}`)}}catch(l){console.log(`Couldn't restore data from local storage: ${l}`)}}),Z(()=>{e(a)&&it().then(()=>{e(a)?.resize()})}),Z(()=>{e(c)&&(console.log(`Autosaving with ${e(L)} reviewed targets`),window.localStorage.setItem(me,JSON.stringify([e(m),e(n)])))});function O(){let l={type:"FeatureCollection",features:[...e(m).features,...e(n).features]};e(a)?.fitBounds(Ee(l),{animate:!1,padding:10})}function S(l){if(e(_)==null)throw new Error("impossible");e(n).features[e(_)].properties.reviewed=l,s(n,e(n),!0),s(_,null)}function x(){for(let l of e(n).features)if(l.properties.reviewed=="unreviewed"){e(a)?.fitBounds(Ee(l),{duration:600,padding:200}),s(_,l.id,!0);return}}function R(l){l.target.tagName=="INPUT"||!e(c)||l.key=="n"&&x()}function i(l){e(c)&&s(_,l.features[0].id,!0)}function z(l){if(!e(c)||e(_)==null)return;let M=l.features[0].id,h=e(n).features[e(_)].properties;h.matching_sources.includes(M)?h.matching_sources=h.matching_sources.filter(p=>p!=M):h.matching_sources.push(M),s(n,e(n),!0)}Be("keydown",He,R),st(f,{left:h=>{var p=Jt(),v=b(q(p),4);{var F=P=>{At(P,{zoomFit:O,get sourceGj(){return e(m)},set sourceGj(T){s(m,T,!0)},get targetGj(){return e(n)},set targetGj(T){s(n,T,!0)},get setupDone(){return e(c)},set setupDone(T){s(c,T,!0)}})},D=P=>{var T=Gt(),A=q(T),u=H(A);u.__click=[Ht,m,n,c,_,w];var X=b(u,2);X.__click=O;var d=b(A,4),$=H(d);let U;var G=b(d,2),K=H(G),W=b(G,2);W.__click=[Bt,n];var k=b(W,2),I=H(k);mt(I,{get checked(){return e(w)},set checked(Y){s(w,Y,!0)},children:(Y,re)=>{var ae=_e("Show labels for matches");y(Y,ae)},$$slots:{default:!0}});var C=b(k,2),B=H(C),Q=b(H(B),2);Ot(Q,{itemsPerRow:1,labelColors:{Confirmed:"green","Not sure":"orange",Unreviewed:"red",Source:"grey"}}),te(Y=>{Ne(d,"aria-valuenow",e(L)),Ne(d,"aria-valuemax",e(n).features.length),U=Ce($,"",U,Y),ie(K,`${e(L)??""} / ${e(n).features.length??""} targets reviewed`)},[()=>({width:`${100*e(L)/e(n).features.length}%`})]),y(P,T)};V(v,P=>{e(c)?P(D,!1):P(F)})}y(h,p)},main:h=>{var p=qt(),v=H(p);ut(v,{get style(){return gt[e(g)]},hash:!0,onerror:F=>{console.log(F.error)},get map(){return e(a)},set map(F){s(a,F,!0)},children:(F,D)=>{var P=Kt(),T=q(P);ct(T,{get map(){return e(a)}});var A=b(T,2);dt(A,{get map(){return e(a)}});var u=b(A,2);ft(u,{get basemap(){return e(g)},set basemap(G){s(g,G,!0)}});var X=b(u,2);{var d=G=>{var K=Ft(),W=H(K);{var k=C=>{var B=Rt();B.__click=x,te(()=>B.disabled=e(L)==e(n).features.length),y(C,B)},I=C=>{Nt(C,{get clickedTarget(){return e(_)},get targetGj(){return e(n)},onConfirm:S,onCancel:()=>s(_,null)})};V(W,C=>{e(_)==null?C(k):C(I,!1)})}y(G,K)};V(X,G=>{e(c)&&G(d)})}var $=b(X,2);Me($,{get data(){return e(m)},children:(G,K)=>{var W=Ut(),k=q(W);{let C=E(()=>({"line-color":["case",["in",["id"],["literal",e(N)]],"blue","black"],"line-width":8,"line-opacity":vt(.5,1)})),B=E(()=>e(_)==null?void 0:"pointer");Te(k,{manageHoverState:!0,get paint(){return e(C)},get hoverCursor(){return e(B)},onclick:z,children:(Q,Y)=>{var re=he(),ae=q(re);{var ve=ee=>{xt(ee,{openOn:"hover",children:(oe,ke)=>{let se=()=>ke?.().data;var le=_e();te(we=>ie(le,`Source ${se().id??""} -- click to ${we??""}`),[()=>e(N).includes(se().id)?"remove":"add"]),y(oe,le)},$$slots:{default:!0}})};V(ae,ee=>{e(_)!=null&&ee(ve)})}y(Q,re)},$$slots:{default:!0}})}var I=b(k,2);{let C=E(()=>({"text-field":["to-string",["id"]],"text-size":16,"symbol-placement":"line",visibility:e(w)?"visible":"none"}));Ie(I,{paint:{"text-color":"white","text-halo-color":"grey","text-halo-width":4},get layout(){return e(C)}})}y(G,W)},$$slots:{default:!0}});var U=b($,2);Me(U,{get data(){return e(n)},children:(G,K)=>{var W=Wt(),k=q(W);{let C=E(()=>({"line-width":["case",[">",["length",["get","matching_sources"]],0],8,16],"line-color":["match",["get","reviewed"],"unreviewed","red","not sure","orange","green"],"line-opacity":["case",["==",["id"],e(_)??-1],1,["boolean",["feature-state","hover"],!1],.6,.3]}));Te(k,{manageHoverState:!0,get paint(){return e(C)},hoverCursor:"pointer",onclick:i})}var I=b(k,2);{let C=E(()=>({"text-field":["case",[">",["length",["get","matching_sources"]],0],["to-string",["get","matching_sources"]],"off-road"],"text-size":16,"symbol-placement":"line",visibility:e(w)?"visible":"none"}));Ie(I,{paint:{"text-color":"white","text-halo-color":["match",["get","reviewed"],"unreviewed","red","not sure","orange","green"],"text-halo-width":4},get layout(){return e(C)}})}y(G,W)},$$slots:{default:!0}}),y(F,P)},$$slots:{default:!0}}),y(h,p)},$$slots:{left:!0,main:!0}}),fe()}Oe(["click"]);_t(Qt,{target:document.getElementById("app")});
