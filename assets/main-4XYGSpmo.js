import{p as Nt,f as ft,a as at,b as At,m as Bt,l as Ot,c as tt,d as Jt,s as T,e as K,g as ht,o as Tt,u as jt,L as Dt,h as Rt,i as qt,_ as Gt,j as v,t as Qt,k as et,M as zt,n as st,S as Ht,q as N,r as Wt,B as Kt,v as A,G as pt,w as dt,x as Z,y as gt,z as Q,A as Zt,C as U,D as Ut,E as Vt,F as vt,H as yt,I as Xt,J as wt,K as Yt,N as te,O as ee,P as re,Q as mt,R as ne,T as ie}from"./Settings-Dy5De1sV.js";function se(e,t={}){const r=Number(e[0]),n=Number(e[1]),a=Number(e[2]),i=Number(e[3]);if(e.length===6)throw new Error("@turf/bbox-polygon does not support BBox with 6 positions");const o=[r,n];return Nt([[o,[a,n],[a,i],[r,i],o]],t.properties,{bbox:e,id:t.id})}const j=11102230246251565e-32,I=134217729,oe=(3+8*j)*j;function ot(e,t,r,n,a){let i,o,u,c,l=t[0],h=n[0],s=0,f=0;h>l==h>-l?(i=l,l=t[++s]):(i=h,h=n[++f]);let p=0;if(s<e&&f<r)for(h>l==h>-l?(o=l+i,u=i-(o-l),l=t[++s]):(o=h+i,u=i-(o-h),h=n[++f]),i=o,u!==0&&(a[p++]=u);s<e&&f<r;)h>l==h>-l?(o=i+l,c=o-i,u=i-(o-c)+(l-c),l=t[++s]):(o=i+h,c=o-i,u=i-(o-c)+(h-c),h=n[++f]),i=o,u!==0&&(a[p++]=u);for(;s<e;)o=i+l,c=o-i,u=i-(o-c)+(l-c),l=t[++s],i=o,u!==0&&(a[p++]=u);for(;f<r;)o=i+h,c=o-i,u=i-(o-c)+(h-c),h=n[++f],i=o,u!==0&&(a[p++]=u);return(i!==0||p===0)&&(a[p++]=i),p}function ae(e,t){let r=t[0];for(let n=1;n<e;n++)r+=t[n];return r}function H(e){return new Float64Array(e)}const ue=(3+16*j)*j,le=(2+12*j)*j,ce=(9+64*j)*j*j,G=H(4),_t=H(8),bt=H(12),Et=H(16),F=H(4);function fe(e,t,r,n,a,i,o){let u,c,l,h,s,f,p,w,g,m,d,E,$,y,_,b,S,L;const P=e-a,M=r-a,C=t-i,x=n-i;y=P*x,f=I*P,p=f-(f-P),w=P-p,f=I*x,g=f-(f-x),m=x-g,_=w*m-(y-p*g-w*g-p*m),b=C*M,f=I*C,p=f-(f-C),w=C-p,f=I*M,g=f-(f-M),m=M-g,S=w*m-(b-p*g-w*g-p*m),d=_-S,s=_-d,G[0]=_-(d+s)+(s-S),E=y+d,s=E-y,$=y-(E-s)+(d-s),d=$-b,s=$-d,G[1]=$-(d+s)+(s-b),L=E+d,s=L-E,G[2]=E-(L-s)+(d-s),G[3]=L;let k=ae(4,G),B=le*o;if(k>=B||-k>=B||(s=e-P,u=e-(P+s)+(s-a),s=r-M,l=r-(M+s)+(s-a),s=t-C,c=t-(C+s)+(s-i),s=n-x,h=n-(x+s)+(s-i),u===0&&c===0&&l===0&&h===0)||(B=ce*o+oe*Math.abs(k),k+=P*h+x*u-(C*l+M*c),k>=B||-k>=B))return k;y=u*x,f=I*u,p=f-(f-u),w=u-p,f=I*x,g=f-(f-x),m=x-g,_=w*m-(y-p*g-w*g-p*m),b=c*M,f=I*c,p=f-(f-c),w=c-p,f=I*M,g=f-(f-M),m=M-g,S=w*m-(b-p*g-w*g-p*m),d=_-S,s=_-d,F[0]=_-(d+s)+(s-S),E=y+d,s=E-y,$=y-(E-s)+(d-s),d=$-b,s=$-d,F[1]=$-(d+s)+(s-b),L=E+d,s=L-E,F[2]=E-(L-s)+(d-s),F[3]=L;const D=ot(4,G,4,F,_t);y=P*h,f=I*P,p=f-(f-P),w=P-p,f=I*h,g=f-(f-h),m=h-g,_=w*m-(y-p*g-w*g-p*m),b=C*l,f=I*C,p=f-(f-C),w=C-p,f=I*l,g=f-(f-l),m=l-g,S=w*m-(b-p*g-w*g-p*m),d=_-S,s=_-d,F[0]=_-(d+s)+(s-S),E=y+d,s=E-y,$=y-(E-s)+(d-s),d=$-b,s=$-d,F[1]=$-(d+s)+(s-b),L=E+d,s=L-E,F[2]=E-(L-s)+(d-s),F[3]=L;const R=ot(D,_t,4,F,bt);y=u*h,f=I*u,p=f-(f-u),w=u-p,f=I*h,g=f-(f-h),m=h-g,_=w*m-(y-p*g-w*g-p*m),b=c*l,f=I*c,p=f-(f-c),w=c-p,f=I*l,g=f-(f-l),m=l-g,S=w*m-(b-p*g-w*g-p*m),d=_-S,s=_-d,F[0]=_-(d+s)+(s-S),E=y+d,s=E-y,$=y-(E-s)+(d-s),d=$-b,s=$-d,F[1]=$-(d+s)+(s-b),L=E+d,s=L-E,F[2]=E-(L-s)+(d-s),F[3]=L;const O=ot(R,bt,4,F,Et);return Et[O-1]}function he(e,t,r,n,a,i){const o=(t-i)*(r-a),u=(e-a)*(n-i),c=o-u,l=Math.abs(o+u);return Math.abs(c)>=ue*l?c:-fe(e,t,r,n,a,i,l)}function pe(e,t){var r,n,a=0,i,o,u,c,l,h,s,f=e[0],p=e[1],w=t.length;for(r=0;r<w;r++){n=0;var g=t[r],m=g.length-1;if(h=g[0],h[0]!==g[m][0]&&h[1]!==g[m][1])throw new Error("First and last coordinates in a ring must be the same");for(o=h[0]-f,u=h[1]-p,n;n<m;n++){if(s=g[n+1],c=s[0]-f,l=s[1]-p,u===0&&l===0){if(c<=0&&o>=0||o<=0&&c>=0)return 0}else if(l>=0&&u<=0||l<=0&&u>=0){if(i=he(o,c,u,l,0,0),i===0)return 0;(i>0&&l>0&&u<=0||i<0&&l<=0&&u>0)&&a++}h=s,u=l,o=c}}return a%2!==0}function de(e){if(!e)throw new Error("coord is required");if(!Array.isArray(e)){if(e.type==="Feature"&&e.geometry!==null&&e.geometry.type==="Point")return[...e.geometry.coordinates];if(e.type==="Point")return[...e.coordinates]}if(Array.isArray(e)&&e.length>=2&&!Array.isArray(e[0])&&!Array.isArray(e[1]))return[...e];throw new Error("coord must be GeoJSON Point or an Array of numbers")}function rt(e){return e.type==="Feature"?e.geometry:e}function z(e,t,r={}){if(!e)throw new Error("point is required");if(!t)throw new Error("polygon is required");const n=de(e),a=rt(t),i=a.type,o=t.bbox;let u=a.coordinates;if(o&&ge(n,o)===!1)return!1;i==="Polygon"&&(u=[u]);let c=!1;for(var l=0;l<u.length;++l){const h=pe(n,u[l]);if(h===0)return!r.ignoreBoundary;h&&(c=!0)}return c}function ge(e,t){return t[0]<=e[0]&&t[1]<=e[1]&&t[2]>=e[0]&&t[3]>=e[1]}class Ct{constructor(t=[],r=ve){if(this.data=t,this.length=this.data.length,this.compare=r,this.length>0)for(let n=(this.length>>1)-1;n>=0;n--)this._down(n)}push(t){this.data.push(t),this.length++,this._up(this.length-1)}pop(){if(this.length===0)return;const t=this.data[0],r=this.data.pop();return this.length--,this.length>0&&(this.data[0]=r,this._down(0)),t}peek(){return this.data[0]}_up(t){const{data:r,compare:n}=this,a=r[t];for(;t>0;){const i=t-1>>1,o=r[i];if(n(a,o)>=0)break;r[t]=o,t=i}r[t]=a}_down(t){const{data:r,compare:n}=this,a=this.length>>1,i=r[t];for(;t<a;){let o=(t<<1)+1,u=r[o];const c=o+1;if(c<this.length&&n(r[c],u)<0&&(o=c,u=r[c]),n(u,i)>=0)break;r[t]=u,t=o}r[t]=i}}function ve(e,t){return e<t?-1:e>t?1:0}function It(e,t){return e.p.x>t.p.x?1:e.p.x<t.p.x?-1:e.p.y!==t.p.y?e.p.y>t.p.y?1:-1:1}function ye(e,t){return e.rightSweepEvent.p.x>t.rightSweepEvent.p.x?1:e.rightSweepEvent.p.x<t.rightSweepEvent.p.x?-1:e.rightSweepEvent.p.y!==t.rightSweepEvent.p.y?e.rightSweepEvent.p.y<t.rightSweepEvent.p.y?1:-1:1}class St{constructor(t,r,n,a){this.p={x:t[0],y:t[1]},this.featureId=r,this.ringId=n,this.eventId=a,this.otherEvent=null,this.isLeftEndpoint=null}isSamePoint(t){return this.p.x===t.p.x&&this.p.y===t.p.y}}function we(e,t){if(e.type==="FeatureCollection"){const r=e.features;for(let n=0;n<r.length;n++)Lt(r[n],t)}else Lt(e,t)}let V=0,X=0,Y=0;function Lt(e,t){const r=e.type==="Feature"?e.geometry:e;let n=r.coordinates;(r.type==="Polygon"||r.type==="MultiLineString")&&(n=[n]),r.type==="LineString"&&(n=[[n]]);for(let a=0;a<n.length;a++)for(let i=0;i<n[a].length;i++){let o=n[a][i][0],u=null;X=X+1;for(let c=0;c<n[a][i].length-1;c++){u=n[a][i][c+1];const l=new St(o,V,X,Y),h=new St(u,V,X,Y+1);l.otherEvent=h,h.otherEvent=l,It(l,h)>0?(h.isLeftEndpoint=!0,l.isLeftEndpoint=!1):(l.isLeftEndpoint=!0,h.isLeftEndpoint=!1),t.push(l),t.push(h),o=u,Y=Y+1}}V=V+1}class me{constructor(t){this.leftSweepEvent=t,this.rightSweepEvent=t.otherEvent}}function _e(e,t){if(e===null||t===null||e.leftSweepEvent.ringId===t.leftSweepEvent.ringId&&(e.rightSweepEvent.isSamePoint(t.leftSweepEvent)||e.rightSweepEvent.isSamePoint(t.leftSweepEvent)||e.rightSweepEvent.isSamePoint(t.rightSweepEvent)||e.leftSweepEvent.isSamePoint(t.leftSweepEvent)||e.leftSweepEvent.isSamePoint(t.rightSweepEvent)))return!1;const r=e.leftSweepEvent.p.x,n=e.leftSweepEvent.p.y,a=e.rightSweepEvent.p.x,i=e.rightSweepEvent.p.y,o=t.leftSweepEvent.p.x,u=t.leftSweepEvent.p.y,c=t.rightSweepEvent.p.x,l=t.rightSweepEvent.p.y,h=(l-u)*(a-r)-(c-o)*(i-n),s=(c-o)*(n-u)-(l-u)*(r-o),f=(a-r)*(n-u)-(i-n)*(r-o);if(h===0)return!1;const p=s/h,w=f/h;if(p>=0&&p<=1&&w>=0&&w<=1){const g=r+p*(a-r),m=n+p*(i-n);return[g,m]}return!1}function be(e,t){t=t||!1;const r=[],n=new Ct([],ye);for(;e.length;){const a=e.pop();if(a.isLeftEndpoint){const i=new me(a);for(let o=0;o<n.data.length;o++){const u=n.data[o];if(t&&u.leftSweepEvent.featureId===a.featureId)continue;const c=_e(i,u);c!==!1&&r.push(c)}n.push(i)}else a.isLeftEndpoint===!1&&n.pop()}return r}function Ee(e,t){const r=new Ct([],It);return we(e,r),be(r,t)}var Se=Ee;function lt(e,t,r={}){const{removeDuplicates:n=!0,ignoreSelfIntersections:a=!0}=r;let i=[];e.type==="FeatureCollection"?i=i.concat(e.features):e.type==="Feature"?i.push(e):(e.type==="LineString"||e.type==="Polygon"||e.type==="MultiLineString"||e.type==="MultiPolygon")&&i.push(ft(e)),t.type==="FeatureCollection"?i=i.concat(t.features):t.type==="Feature"?i.push(t):(t.type==="LineString"||t.type==="Polygon"||t.type==="MultiLineString"||t.type==="MultiPolygon")&&i.push(ft(t));const o=Se(at(i),a);let u=[];if(n){const c={};o.forEach(l=>{const h=l.join(",");c[h]||(c[h]=!0,u.push(l))})}else u=o;return at(u.map(c=>At(c)))}function ut(e,t={}){const r=rt(e);switch(!t.properties&&e.type==="Feature"&&(t.properties=e.properties),r.type){case"Polygon":return Le(r,t);case"MultiPolygon":return Pe(r,t);default:throw new Error("invalid poly")}}function Le(e,t={}){const n=rt(e).coordinates,a=t.properties?t.properties:e.type==="Feature"?e.properties:{};return kt(n,a)}function Pe(e,t={}){const n=rt(e).coordinates,a=t.properties?t.properties:e.type==="Feature"?e.properties:{},i=[];return n.forEach(o=>{i.push(kt(o,a))}),at(i)}function kt(e,t){return e.length>1?Bt(e,t):Ot(e[0],t)}function xe(e,t,{ignoreSelfIntersections:r=!0}={ignoreSelfIntersections:!0}){let n=!0;return tt(e,a=>{tt(t,i=>{if(n===!1)return!1;n=$e(a.geometry,i.geometry,r)})}),n}function $e(e,t,r){switch(e.type){case"Point":switch(t.type){case"Point":return!Fe(e.coordinates,t.coordinates);case"LineString":return!Pt(t,e);case"Polygon":return!z(e,t)}break;case"LineString":switch(t.type){case"Point":return!Pt(e,t);case"LineString":return!Ce(e,t,r);case"Polygon":return!xt(t,e,r)}break;case"Polygon":switch(t.type){case"Point":return!z(t,e);case"LineString":return!xt(e,t,r);case"Polygon":return!Ie(t,e,r)}}return!1}function Pt(e,t){for(let r=0;r<e.coordinates.length-1;r++)if(ke(e.coordinates[r],e.coordinates[r+1],t.coordinates))return!0;return!1}function Ce(e,t,r){return lt(e,t,{ignoreSelfIntersections:r}).features.length>0}function xt(e,t,r){for(const a of t.coordinates)if(z(a,e))return!0;return lt(t,ut(e),{ignoreSelfIntersections:r}).features.length>0}function Ie(e,t,r){for(const a of e.coordinates[0])if(z(a,t))return!0;for(const a of t.coordinates[0])if(z(a,e))return!0;return lt(ut(e),ut(t),{ignoreSelfIntersections:r}).features.length>0}function ke(e,t,r){const n=r[0]-e[0],a=r[1]-e[1],i=t[0]-e[0],o=t[1]-e[1];return n*o-a*i!==0?!1:Math.abs(i)>=Math.abs(o)?i>0?e[0]<=r[0]&&r[0]<=t[0]:t[0]<=r[0]&&r[0]<=e[0]:o>0?e[1]<=r[1]&&r[1]<=t[1]:t[1]<=r[1]&&r[1]<=e[1]}function Fe(e,t){return e[0]===t[0]&&e[1]===t[1]}function $t(e,t,{ignoreSelfIntersections:r=!0}={}){let n=!1;return tt(e,a=>{tt(t,i=>{if(n===!0)return!0;n=!xe(a.geometry,i.geometry,{ignoreSelfIntersections:r})})}),n}async function Me(e,t,r,n,a,i,o,u){if(!v(t)?.files)return;if(v(t).files.length!=2){window.alert("Select two GeoJSON files");return}try{A(r,await n(v(t).files[0]),!0),A(a,await n(v(t).files[1]),!0),i(),A(o,void 0),u()}catch(l){window.alert(`Bad input file: ${l}`)}}function Ne(e,t,r,n){(a=>{var i=ne(a,2);A(t,i[0],!0),A(r,i[1],!0)})([v(r),v(t)]),n()}var Ae=et('<button class="btn btn-secondary">Swap</button> <button class="btn btn-secondary">Zoom to fit</button> <div>Sources</div> <p> </p> <div>Target</div> <p> </p> <!> <!>',1),Be=et('<h1>Match LineStrings</h1> <a href="review.html">Looking for the tool to review test cases?</a> <label class="form-label">Load two .geojson files <input class="form-control" type="file" multiple/></label> <!>',1),Oe=et("<!> <!> <!> <!> <!>",1),Je=et('<div style="position:relative; width: 100%; height: 100vh;"><!></div>');function Te(e,t){qt(t,!0);let r=T(void 0),n=T("Maptiler Dataviz"),a=T(K(ht())),i="red",o=T(K(ht())),u="blue",c=T(void 0),l=T(!0),h=T(K({buffer_meters:20,angle_diff_threshold:10,length_ratio_threshold:1.1,midpt_dist_threshold:15})),s=T(K([]));Tt(async()=>{await Gt()}),jt(()=>{v(r)&&Qt().then(()=>{v(r)?.resize()})});let f=Z(()=>v(c)?v(s)[v(c).id].matching_sources:[]);function p(){try{A(s,JSON.parse(Xt(JSON.stringify(v(a)),JSON.stringify(v(o)),v(h))),!0)}catch(y){window.alert(`Bug: ${y}`);return}for(let[y,_]of v(o).features.entries())_.properties.has_match=v(s)[y].matching_sources.length>0}let w=T(void 0);async function g(y){let _=await y.text(),b=JSON.parse(_),S=0;for(let L of b.features)L.id=S++,L.properties??={};return b}function m(){let y={type:"FeatureCollection",features:[...v(a).features,...v(o).features]};v(r)?.fitBounds(vt(y),{animate:!1,padding:10})}function d(y){let _=JSON.parse(JSON.stringify(y));return delete _.properties,_}function E(y){let _=0;for(let b of y)b.id=_++;return y}function $(y){let _=v(o).features[y.features[0].id],b=se(vt(_));yt("sources.geojson",JSON.stringify({type:"FeatureCollection",features:E(v(a).features.filter(S=>$t(S,b)).map(d))})),yt("targets.geojson",JSON.stringify({type:"FeatureCollection",features:E(v(o).features.filter(S=>$t(S,b)).map(d))}))}Dt(e,{left:b=>{var S=Be(),L=N(st(S),4),P=N(U(L));P.__change=[Me,w,a,g,o,m,c,p],Ut(P,x=>A(w,x),()=>v(w));var M=N(L,2);{var C=x=>{var k=Ae(),B=st(k);B.__click=[Ne,a,o,p];var D=N(B,2);D.__click=m;var R=N(D,2);wt(R,"",{},{background:i});var O=N(R,2),nt=U(O),q=N(O,2);wt(q,"",{},{background:u});var W=N(q,2),it=U(W),ct=N(W,2);Yt(ct,{get checked(){return v(l)},set checked(J){A(l,J,!0)},children:(J,je)=>{var Mt=te("Show targets matching a source");Q(J,Mt)},$$slots:{default:!0}});var Ft=N(ct,2);ee(Ft,{onChange:p,get options(){return v(h)},set options(J){A(h,J,!0)}}),re(J=>{mt(nt,`${v(a).features.length??""} sources`),mt(it,`${v(o).features.length??""} targets, with ${J??""} matching a source`)},[()=>v(s).filter(J=>J.matching_sources.length>0).length]),Q(x,k)};Vt(M,x=>{v(a).features.length>0&&x(C)})}Q(b,S)},main:b=>{var S=Je(),L=U(S);zt(L,{get style(){return Zt[v(n)]},hash:!0,onerror:P=>{console.log(P.error)},get map(){return v(r)},set map(P){A(r,P,!0)},children:(P,M)=>{var C=Oe(),x=st(C);Ht(x,{get map(){return v(r)}});var k=N(x,2);Wt(k,{get map(){return v(r)}});var B=N(k,2);Kt(B,{get basemap(){return v(n)},set basemap(O){A(n,O,!0)}});var D=N(B,2);pt(D,{get data(){return v(a)},children:(O,nt)=>{{let q=Z(()=>({"line-width":["case",["in",["id"],["literal",v(f)]],8,5],"line-color":i,"line-opacity":gt(.5,1)}));dt(O,{manageHoverState:!0,get paint(){return v(q)}})}},$$slots:{default:!0}});var R=N(D,2);pt(R,{get data(){return v(o)},children:(O,nt)=>{{let q=Z(()=>v(l)?void 0:["!",["get","has_match"]]),W=Z(()=>({"line-width":8,"line-color":u,"line-opacity":gt(["case",["get","has_match"],.5,.2],1)}));dt(O,{manageHoverState:!0,get filter(){return v(q)},get paint(){return v(W)},onclick:$,get hovered(){return v(c)},set hovered(it){A(c,it,!0)}})}},$$slots:{default:!0}}),Q(P,C)},$$slots:{default:!0}}),Q(b,S)},$$slots:{left:!0,main:!0}}),Rt()}Jt(["change","click"]);ie(Te,{target:document.getElementById("app")});
